<!-- sections/quick-add.liquid -->
{% comment %} 
  Use section rendering API to load and inject quick-add form for product thumbnails.

  Globals:
  - color_background_overlay: {string} Sets the background color of the overlay.
  - enable_animations: {boolean} Indicates if animations should be enabled.
  - enable_quick_image: {boolean} Indicates if quick image should be enabled.
  - product_card_enable_count: {boolean} Indicates if variant count should be displayed on thumbnails.
  - product_card_enable_sku: {boolean} Indicates if SKU should be displayed on thumbnails.
  - product_card_enable_vendor: {boolean} Indicates if vendor should be displayed on thumbnails.
  - product_card_enable_type: {boolean} Indicates if product type should be displayed on thumbnails.
   
  Recommendations:
  - Use variant dropdown selectors for products that have lots of variant options.
{% endcomment %}

{% capture script_product %}
  {% render 'script__product',
    gallery_style: 'slider',
    enable_default_selling_plan_widget: true,
    enable_default_variant: false,
  %}
{% endcapture %}

<section 
  class="fixed inset-0 z-50 overflow-hidden "
  aria-modal="true"
  role="dialog"
  x-data="{
    quick_add: true,
    pos_y: 0, 
    dragging: false 
  }"
  @keyup.escape.window="
    quick_add = false;
    has_overlay = false;
  "
  x-show="quick_add" 
  x-cloak>

  {% comment %} Overlay {% endcomment %}
  <div 
    class="absolute inset-0 w-full h-full backdrop-blur-sm"
    style="
      background: {{ settings.color_background_overlay }};
    "
    aria-hidden="true"
    @click="
      quick_add = false; 
      has_overlay = false;
    "
    x-show="quick_add"
    {% if settings.enable_animations %}
      x-transition:enter="animation-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="animation-300"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
    {% endif %}
    x-cloak>
  </div>

  {% comment %} Drawer {% endcomment %}
  <div
    class="
      fixed flex w-screen max-h-[90svh]
      md:max-h-full md:max-w-xl md:h-full md:top-0 md:bottom-0 md:left-auto md:right-0
      bottom-0 left-0 right-0 justify-end
    "
    :class="[
      dragging ? '' : 'animation-300'
    ]"
    @touchend.window="
      dragging = false;
      start_y: 0,
      pos_y = 0;
    "
    @touchstart="
      dragging = true;
      start_y = $event.touches[0].clientY;
    "
    @touchmove.window="
      if (dragging) { 
        let deltaY = $event.touches[0].clientY - start_y;
        if (deltaY > 0) {
          pos_y = deltaY;
          if (pos_y > window.innerHeight / 3) {
            dragging = false;
            pos_y = 1200;
            quick_add = false;
            has_overlay = false;
          }
        } else {
          pos_y = 0;
        }
      }
    "
    :style="
      'transform: translate(0px, ' + pos_y + 'px)'
    "
    x-trap="quick_add"
    x-show="quick_add"
    {% if settings.enable_animations %}
      {% capture transition_start %}
        !translate-y-full md:!translate-y-0
      {% endcapture %}
      x-transition:enter="animation-300 opacity-0 {{ transition_start | strip }}"
      x-transition:enter-start="opacity-0 {{ transition_start | strip }}"
      x-transition:enter-end="!translate-y-0 opacity-100"
      x-transition:leave="animation-300 !translate-y-0 opacity-100"
      x-transition:leave-start="!translate-y-0 opacity-100"
      x-transition:leave-end="opacity-0 {{ transition_start | strip }}"
    {% endif %}
    x-cloak>

    {% comment %} Contents {% endcomment %}
    <div class="w-screen">
      <div class="flex flex-col h-full overflow-y-auto color__bg-body color__text overscroll-none">
        <div 
          class="h-full"
          x-data="{{ script_product }}"
          x-init="initProductForm();"
          x-ref="formContainer">
          <form 
            class="flex flex-col w-full h-full flex-nowrap"
            method="post" 
            action="/cart/add" 
            id="product_form_{{ product.id }}-{{ section.id }}" 
            accept-charset="UTF-8"
            enctype="multipart/form-data"
            @submit.prevent="
              submitCartForm($event.target, true); 
              button_loading = true; 
              quick_add = false; 
              quick_edit_handle = false;
              setTimeout(function(){ button_loading = false}, 500);
            "
            x-on:keydown.enter.prevent=""
            @change="handleProductFormChange();">
            
            {% comment %} Top bar {% endcomment %}
            <section class="sticky top-0 z-10 items-center justify-between hidden p-4 border--b-width md:flex color__bg-body">
              <span>{{ product.title }}</span>
              <button 
                class="
                  btn
                  {{ settings.close_button_color }}
                "
                type="button"
                title="{{ 'actions.close' | t }}"
                @click="
                  quick_edit = false; 
                  quick_add = false; 
                  has_overlay = false;
                ">
                {% if settings.close_button_content contains 'icon' %}
                  {% render 'component__icon', icon: 'x', size: '20' %} 
                {% endif %}
                {% if settings.close_button_content contains 'text' %}
                  <span 
                    {% if settings.close_button_content contains 'icon' %}class="ml-1"{% endif %}>
                    {{ 'actions.close' | t }}
                  </span>
                {% endif %}
              </button>
            </section>
            
            {% comment %} Images {% endcomment %}
            {% if settings.enable_quick_image and product.featured_image != blank  %}
              {% render 'product__gallery-slider',
                is_overlay: true
              %}
            {% endif %}
            
            {% comment %} Details and actions {% endcomment %}
            <div 
              class="flex flex-col flex-grow w-full flex-nowrap border--t-width color__border-divider-1">

              {% comment %} Details {% endcomment %}
              <div class="flex flex-col gap-2 py-4">

                {% comment %} Details {% endcomment %}
                <div 
                  class="relative z-10 flex flex-col items-start justify-between gap-2 px-4 color__bg-body">

                  {% comment %} Title {% endcomment %}
                  <h3 class="type__heading type__heading-5 md:hidden">
                    {{ product.title }}
                  </h3>
                  
                  {% comment %} Price {% endcomment %}
                  <div class="hidden md:block">
                    {% if product.metafields.reviews.rating.value != blank %}
                      {% assign rating = product.metafields.reviews.rating.value.rating | times: 1 %}
                      {% assign rating_floor = rating | floor %}
                      {% assign max = product.metafields.reviews.rating.value.scale_max | floor %}

                      <div class="flex items-center gap-0.5">
                        {% liquid 
                          for iteration in (1..max)
                            if iteration <= rating_floor
                              render 'component__icon', icon: 'star-fill', size: '16', class: ''
                            endif
                          endfor 
                          assign rating_string = rating | append: ""
                          unless rating_string contains '.0'
                            render 'component__icon', icon: 'star-half', size: '16', class: ''
                          endunless
                        %}
                        <span class="opacity-50 type--smaller">({{ product.metafields.reviews.rating_count }})</span>
                      </div>
                    {% endif %}
                  </div>
                  
                  {% comment %} Price {% endcomment %}
                  <div 
                    x-show="current_variant_exists">
                    {% render 'product__price' %}
                  </div>

                </div>

                {% comment %} Description and learn more {% endcomment %}
                <div class="flex flex-col gap-2 px-4">

                  {% comment %} Description {% endcomment %}
                  {% unless product.description == blank %}
                    <div class="hidden md:block">
                      {{ product.description | truncate: 500 }}
                    </div>
                  {% endunless %}
                    
                  {% comment %} Learn more {% endcomment %}
                  <div>
                    <a 
                      class="btn btn--small btn--plain"
                      href="{{ product.url }}">
                      {{ 'actions.learn_more' | t }}
                    </a>
                  </div>
                  
                </div>

              </div>

              {% comment %} Options {% endcomment %}
              <div class="sticky z-20 py-4 bottom-16 color__bg-body border--t-width color__border-divider-1">
                {% render 'product__options', 
                  is_product_template: false,
                  enable_default_selling_plan_widget: true 
                %}
              </div>
              
              {% comment %} Actions {% endcomment %}
              <div 
                class="sticky bottom-0 z-10 flex flex-wrap items-end content-end flex-grow w-full py-4 color__bg-body border--t-width color__border-divider-1">
                {% render 'product__add', 
                  is_product_template: false,
                  is_featured: false,
                  is_edit_section: false
                %}
              </div>

            </div>
        
          </form>
        </div>
      </div>
    </div>

  </div>

</section>