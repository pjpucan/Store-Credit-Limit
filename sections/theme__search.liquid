<!-- sections/theme__search.liquid -->
{% comment %} 
  This file is responsible for the rendering and functionality of the search section in a Shopify store. It includes the slide-out search drawer and handles the display of search results.

  Globals:
  - close_button_color: {string} Sets the color of the navigation button.
  - close_button_content: {string} Determines the content of the navigation button (icon, text, or both).
  - layout_gap_size: {integer} Defines the gap size in the layout.
  - enable_search_article: {boolean} Indicates if article search is enabled.
  - enable_search_collection: {boolean} Indicates if collection search is enabled.
  - enable_search_page: {boolean} Indicates if page search is enabled.
  - enable_search_product: {boolean} Indicates if product search is enabled.
  - enable_search_query: {boolean} Indicates if query search is enabled.
{% endcomment %}

{% capture search_content %}

  {% comment %} Announcement bar {% endcomment %}
  {% for block in section.blocks %}
    {% if block.type == 'announcement' %}
      <section class="{{ block.settings.color_scheme }}">
        <div class="p-2">
          <div class="flex w-full
            {% if block.settings.layout_x_alignment == "center" %}
              justify-center
            {% elsif block.settings.layout_x_alignment == "right" %}
              justify-end
            {% endif %}">
            <span class="type--smaller">{{ block.settings.content }}</span>
          </div>
        </div>
      </section>
    {% endif %}
  {% endfor %}

  {% comment %} Top bar {% endcomment %}
  <section
    class="
      border--b-width p-4 items-center hidden md:flex justify-between
      {{ section.settings.top_color_scheme }}
      {{ section.settings.top_color_border }}
    ">
    <span>{{ 'labels.search' | t }}</span>
    <button 
      class="
        btn
        {{ settings.close_button_color }}
      "
      title="{{ 'actions.close' | t }}"
      @click="closeSearch()">
      {% if settings.close_button_content contains 'icon' %}
        {% render 'component__icon', icon: 'x', size: '20' %} 
      {% endif %}
      {% if settings.close_button_content contains 'text' %}
        <span 
          {% if settings.close_button_content contains 'icon' %}
            class="ml-1"
          {% endif %}>
          {{ 'actions.close' | t }}
        </span>
      {% endif %}
    </button>
  </section>
  
  {% comment %} Drawer contents {% endcomment %}
  <section 
    class="
      relative h-[inherit] overflow-y-auto overflow-x-hidden
      {{ section.settings.main_color_scheme }}
    "
    x-data="{
      params: {
        author: true,
        body: true,
        product_type: true,
        tag: true,
        title: true,
        variants_barcode: true,
        variants_sku: true,
        variants_title: true,
        vendor: true,
      },
      resources: {
        article: {{ settings.enable_search_article }},
        collection: {{ settings.enable_search_collection }},
        page: {{ settings.enable_search_page }},
        product: {{ settings.enable_search_product }},
        query: true
      }
    }">
    <form 
      action="{{ routes.search_url }}" 
      method='get'
      @submit.prevent="goToSelectedItem($el)">

      {% capture search_types %}
        {% if settings.enable_search_product %}product,{% endif %}
        {% if settings.enable_search_page %}page,{% endif %}
        {% if settings.enable_search_article %}article,{% endif %}
      {% endcapture %}
      <input type="hidden" name="type" value="{{ search_types | strip }}"/>

      {% comment %} Search action {% endcomment %}
      <div 
        class="
          sticky top-0 w-full p-4 z-10 border--b-width
          {{ section.settings.main_color_border }}
          {{ section.settings.main_color_scheme }}
        ">

        {% comment %} Input field {% endcomment %}
        <div 
          class="relative">
          <label 
            class="sr-only"
            for="search-desktop">
            {{ 'labels.search' | t }}
          </label>

          {% comment %} Icon {% endcomment %}
          <div 
            class="absolute top-0 flex items-center h-full opacity-50 pointer-events-none left-2">
            {% render 'component__icon', 
              icon: 'search',
              size: '20' %}
          </div>

          {% comment %} Input {% endcomment %}
          <input 
            id="search-field"
            class="
              color__text color__bg-overlay-1 !border-transparent !px-10
              {{ section.settings.main_color_border }}
            " 
            type="text"
            name="q" 
            placeholder="{{ 'actions.search_placeholder' | t }}"
            role="combobox"
            aria-controls="options"
            x-ref="searchInput"
            @keyup.down="updateSelectedSearch(1)"
            @keyup.up="updateSelectedSearch(-1)"
            @keyup.enter.prevent="goToSelectedItem()"
            @input.debounce="fetchAndUpdateSearch($event, params, resources)"
          />
          
          {% comment %} Cancel {% endcomment %}
          <div 
            class="absolute top-0 flex items-center h-full right-2">
            <button 
              class="btn btn--smaller btn--minimal !px-2"
              title="{{ 'actions.cancel' | t }}"
              type="button"
              @click="
                $refs.searchInput.value = '';
                search_term = '';
                search_items = '';
                search_items_collections = '';
                search_items_pages = '';
                search_items_articles = '';
                search_items_queries = '';
                search_loading = false;
              ">
              {% render 'component__icon', 
                icon: 'x',
                size: '16' %}
            </button>
          </div>
        
        </div>

        {% comment %} View all {% endcomment %}
        <div
          class="pt-4" 
          x-show="search_items.length != 0 && !search_loading"
          x-cloak>
          <button class="w-full text-left"
            type="submit">
            {{ 'actions.view_all' | t }} 
          </button>
        </div>

        {% comment %} No results {% endcomment %}
        <div
          class="pt-4"
          x-show="
            search_term.length > 0 &&
            search_items.length == 0 &&
            search_items_collections.length == 0 &&
            search_items_pages.length == 0 &&
            search_items_articles.length == 0 &&
            search_items_queries.length == 0 &&
            !search_loading"
          x-cloak>
          <p class="mb-0">{{ 'info.search_no_results' | t }}</p>
        </div>
            
        {% comment %} Loading indciator {% endcomment %}
        <div 
          class="pt-4" 
          x-show="search_loading" 
          x-cloak>
          <div class="btn--load btn--loading">
            <div class="btn__content">{{ 'info.loading' | t }}</div>
            <div class="btn__spinner">
              {% render 'component__icon', 
                icon: 'spinner', 
                size: '24' %}
            </div>
          </div>
        </div>
          
      </div>
      
      {% comment %} Main content {% endcomment %}
      <div>
        
        {% comment %} Search manual suggestions {% endcomment %}
        {% unless section.settings.search_links == blank %}
        <div 
          class="mb-10"
          x-show="search_term.length == 0 && !search_loading"
          x-cloak>

          <span 
            class="flex w-full p-4 opacity-50 type__body">
            {{ 'labels.top_searches' | t }}
          </span>
          {% for link in section.settings.search_links.links %}
            <a 
              class="flex w-full px-4 py-4 overflow-hidden font-bold no-underline type--bigger text-ellipsis"
              href="{{ link.url }}">
              {{ link.title }}
            </a>
          {% endfor %}
        </div>
        {% endunless %}
        
        {% comment %} Search results {% endcomment %}
        <div 
          x-show="search_term.length > 0 && !search_loading" 
          x-cloak>
          
          
          {% comment %} Query suggestions {% endcomment %}
          <div 
            class="
              border--b-width
              {{ section.settings.main_color_border }}
            "
            x-show="search_items_queries.length !== 0"
            x-cloak>
            <template x-for="(item, index)  in search_items_queries">
              <a 
                class="flex items-center w-full gap-4 px-4 py-4 overflow-hidden no-underline text-ellipsis hover:color__bg-shade-2 hover:opacity-100 animation-100"
                :class="{ 
                  'underline color__bg-shade-1': index === search_focus_index, 
                  'no-underline': index !== search_focus_index 
                }"
                :href="item.url">
                <span class="flex items-center justify-center w-10 h-10 shrink-0 color__bg-overlay-1 border--radius">
                  {% render 'component__icon', 
                    icon: 'search',
                    size: '16' %}
                </span>
                <span
                  x-html="item.styled_text">
                </span>
              </a>
            </template>
          </div>
          
          {% comment %} Pages {% endcomment %}
          <div 
            class="
              border--b-width
              {{ section.settings.main_color_border }}
            "
            x-show="search_items_pages.length !== 0"
            x-cloak>

            <template x-for="(item, index) in search_items_pages" :key="index">
              <a 
                class="flex items-center w-full gap-4 px-4 py-4 overflow-hidden no-underline text-ellipsis hover:color__bg-shade-2 hover:opacity-100 animation-100"
                :class="{ 
                  'underline color__bg-shade-1': (index + search_items_queries.length) === search_focus_index, 
                  'no-underline': (index + search_items_queries.length) !== search_focus_index 
                }"
                :href="item.url">
                <span class="flex items-center justify-center w-10 h-10 shrink-0 color__bg-overlay-1 border--radius">
                  {% render 'component__icon', 
                    icon: 'page',
                    size: '16' %}
                </span>
                <span
                  x-html="item.title">
                </span>
              </a>
            </template>
          </div>

          {% comment %} Articles {% endcomment %}
          <div 
            class="
              border--b-width
              {{ section.settings.main_color_border }}
            "
            x-show="search_items_articles.length !== 0"
            x-cloak>
            <template x-for="(item, index) in search_items_articles">
              <a 
                class="flex items-center w-full gap-4 px-4 py-4 overflow-hidden no-underline text-ellipsis hover:color__bg-shade-2 hover:opacity-100 animation-100"
                :class="{ 
                  'underline color__bg-shade-1': (index + search_items_queries.length + search_items_pages.length) === search_focus_index, 
                  'no-underline': (index + search_items_queries.length + search_items_pages.length) !== search_focus_index 
                }"
                :href="item.url">
                <span class="flex items-center justify-center w-10 h-10 shrink-0 color__bg-overlay-1 border--radius">
                  {% render 'component__icon', 
                    icon: 'page',
                    size: '16' %}
                </span>
                <span
                  x-html="item.title">
                </span>
              </a>
            </template>
          </div>

          {% comment %} Collections {% endcomment %}
          <div 
            class="
              border--b-width
              {{ section.settings.main_color_border }}
            "
            x-show="search_items_collections.length !== 0"
            x-cloak>
            <template x-for="(item, index) in search_items_collections">
              <a 
                class="flex items-center w-full gap-4 px-4 py-4 overflow-hidden no-underline text-ellipsis hover:color__bg-shade-2 hover:opacity-100 animation-100"
                :class="{ 
                  'underline color__bg-shade-1': (index + search_items_queries.length + search_items_pages.length + search_items_articles.length) === search_focus_index, 
                  'no-underline': (index + search_items_queries.length + search_items_pages.length + search_items_articles.length) !== search_focus_index 
                }"
                :href="item.url">
                <span 
                  class="flex items-center justify-center w-10 h-10 overflow-hidden shrink-0 color__bg-overlay-1 border--radius"
                  x-show="item.featured_image && item.featured_image.url">
                  <img 
                    class="w-full h-full"
                    width="64"
                    height="64"
                    loading="lazy"
                    :src="item.featured_image && item.featured_image.url ? `${item.featured_image.url}&width=64` : ''" 
                    :alt="`${item.title}`" />
                </span>
                <span 
                  class="flex items-center justify-center w-10 h-10 overflow-hidden shrink-0 color__bg-overlay-1 border--radius"
                  x-show="!item.featured_image || !item.featured_image.url">
                  {% render 'component__icon', 
                    icon: 'grid',
                    size: '16' %}
                </span>
                <span
                  x-html="item.title">
                </span>
              </a>
            </template>
          </div>
          
          {% comment %} Products - mobile only {% endcomment %}
          <div 
            class="
              border--b-width md:hidden
              {{ section.settings.main_color_border }}
            "
            x-show="search_items.length > 0"
            x-cloak>
            <template x-for="(item, index) in search_items">
              <a 
                class="flex items-center w-full gap-4 px-4 py-4 overflow-hidden no-underline text-ellipsis hover:color__bg-shade-2 hover:opacity-100 animation-100"
                :class="{ 
                  'underline color__bg-shade-1': (index + search_items_queries.length + search_items_pages.length + search_items_articles.length + search_items_collections.length) === search_focus_index, 
                  'no-underline': (index + search_items_queries.length + search_items_pages.length + search_items_articles.length + search_items_collections.length) !== search_focus_index 
                }"
                :href="item.url">
                <span class="flex items-center justify-center w-10 h-10 overflow-hidden shrink-0 color__bg-overlay-1 border--radius">
                  <img 
                    class="w-full h-full"
                    width="64"
                    loading="lazy"
                    :src="`${item.image}&width=64`" 
                    :alt="`${item.title}`" 
                  />
                </span>
                <div class="inline-flex items-start">
                  <span
                    x-html="item.title">
                  </span>
                  <div class="flex flex-wrap items-center justify-end ml-2 gap-x-2 gap-y-0">
                    <span 
                      class="type--base"
                      x-html="Shopify.formatMoney(item.price)">
                    </span>
                    <span 
                      class="opacity-50 type--base"
                      x-show="item.compare_at_price_max > item.price">
                      <s 
                        x-html="Shopify.formatMoney(item.compare_at_price_max)">
                      </s>
                    </span>
                  </div> 
                </div>  
              </a>
            </template>
          </div>

          
        </div>
      </div>

      {% comment %} Product results - desktop {% endcomment %}
      <div 
        class="
          w-full overflow-y-scroll h-full md:flex flex-col items-stretch top-0 bottom-0 color__border-divider-1 hidden border--l-width max-w-[calc(100vw-36rem)] fixed -z-10 left-[36rem]
          {{ section.settings.main_color_scheme }}
        "
        x-show="search_items.length > 0"
        {% if settings.enable_animations %}
          x-transition:enter="animation-300"
          x-transition:enter-start="opacity-0"
          x-transition:enter-end="opacity-100"
          x-transition:leave="animation-300"
          x-transition:leave-start="opacity-100"
          x-transition:leave-end="opacity-0"
        {% endif %}
        x-cloak>
        <div>
          <div 
            class="grid animation-300"
            style="
              gap: {{ settings.gap_size }}px;
              {% unless settings.gap_size == 1 %}
                padding: {{ settings.gap_size }}px;
              {% endunless %}
            ">
            <template x-for="(item, index) in search_items">
              {% render 'template__search-item' %}
            </template>
          </div>
        </div>
      </div>

    </form>
  </section>

{% endcapture %}

{% render 'component__dragdrawer', 
  drawer_id: 'search_drawer',
  mobile_pos: 'bottom',
  desktop_pos: 'left',
  enable_full_height: true,
  content: search_content 
%}

{% schema %}
{
  "name":"t:sections.theme_search.name",
  "settings":[
    {
      "type":"header",
      "content":"t:general.headers.navigation.content"
    },
    {
      "type":"link_list",
      "id":"search_links",
      "label":"t:general.settings.search_recommendations.label",
      "info":"t:general.settings.search_recommendations.info"
    },
    {
      "type":"header",
      "content":"t:general.headers.top_bar.content"
    },
    {
      "type":"select",
      "id":"top_color_scheme",
      "label":"t:general.settings.color_scheme.label",
      "options":[
        {
          "value":"color__bg-body color__text",
          "label":"t:general.settings.color_scheme.body.label"
        },
        {
          "value":"color__bg-neutral color__text",
          "label":"t:general.settings.color_scheme.neutral.label"
        },
        {
          "value":"color__bg-overlay-1 color__text",
          "label":"t:general.settings.color_scheme.accent_1.label"
        },
        {
          "value":"color__bg-overlay-2 color__text",
          "label":"t:general.settings.color_scheme.accent_2.label"
        },
        {
          "value":"color__bg-overlay-3 color__text",
          "label":"t:general.settings.color_scheme.accent_3.label"
        },
        {
          "value":"color__bg-shade-1 color__text",
          "label":"t:general.settings.color_scheme.shade_1.label"
        },
        {
          "value":"color__bg-shade-2 color__text",
          "label":"t:general.settings.color_scheme.shade_2.label"
        },
        {
          "value":"color__bg-shade-3 color__text",
          "label":"t:general.settings.color_scheme.shade_3.label"
        },
        {
          "value":"color__bg-primary color__primary",
          "label":"t:general.settings.color_scheme.primary.label"
        },
        {
          "value":"color__bg-secondary color__secondary",
          "label":"t:general.settings.color_scheme.secondary.label"
        },
        {
          "value":"color__bg-tertiary color__tertiary",
          "label":"t:general.settings.color_scheme.tertiary.label"
        }
      ],
      "default":"color__bg-body color__text"
    },
    {
      "type":"select",
      "id":"top_color_border",
      "label":"t:general.settings.color_border.label",
      "options":[
        {
          "value":"color__border-divider-1",
          "label":"t:general.settings.color_border.subtle.label"
        },
        {
          "value":"color__border-selected-1",
          "label":"t:general.settings.color_border.strong.label"
        },
        {
          "value":"!color__border-transparent",
          "label":"t:general.settings.color_border.none.label"
        }
      ],
      "default":"color__border-divider-1"
    },
    {
      "type":"header",
      "content":"t:general.headers.main_section.content"
    },
    {
      "type":"select",
      "id":"main_color_scheme",
      "label":"t:general.settings.color_scheme.label",
          "options":[
            {
              "value":"color__bg-body color__text",
              "label":"t:general.settings.color_scheme.body.label"
            },
            {
              "value":"color__bg-neutral color__text",
              "label":"t:general.settings.color_scheme.neutral.label"
            },
            {
              "value":"color__bg-overlay-1 color__text",
              "label":"t:general.settings.color_scheme.accent_1.label"
            },
            {
              "value":"color__bg-overlay-2 color__text",
              "label":"t:general.settings.color_scheme.accent_2.label"
            },
            {
              "value":"color__bg-overlay-3 color__text",
              "label":"t:general.settings.color_scheme.accent_3.label"
            },
            {
              "value":"color__bg-shade-1 color__text",
              "label":"t:general.settings.color_scheme.shade_1.label"
            },
            {
              "value":"color__bg-shade-2 color__text",
              "label":"t:general.settings.color_scheme.shade_2.label"
            },
            {
              "value":"color__bg-shade-3 color__text",
              "label":"t:general.settings.color_scheme.shade_3.label"
            },
            {
              "value":"color__bg-primary color__primary",
              "label":"t:general.settings.color_scheme.primary.label"
            },
            {
              "value":"color__bg-secondary color__secondary",
              "label":"t:general.settings.color_scheme.secondary.label"
            },
            {
              "value":"color__bg-tertiary color__tertiary",
              "label":"t:general.settings.color_scheme.tertiary.label"
            }
          ],
      "default":"color__bg-body color__text"
    },
    {
      "type":"select",
      "id":"main_color_border",
      "label":"t:general.settings.color_border.label",
      "options":[
        {
          "value":"color__border-divider-1",
          "label":"t:general.settings.color_border.subtle.label"
        },
        {
          "value":"color__border-selected-1",
          "label":"t:general.settings.color_border.strong.label"
        },
        {
          "value":"!color__border-transparent",
          "label":"t:general.settings.color_border.none.label"
        }
      ],
      "default":"color__border-divider-1"
    }
  ],
  "blocks": [
    {
      "type": "announcement",
      "name":"t:sections.theme_search.blocks.announcement.name",
      "limit": 1,
      "settings": [
        {
          "type": "header",
          "content": "t:general.headers.content.content"
        },
        {
          "type":"richtext",
          "id":"content",
          "label":"t:general.settings.content.label",
          "default":{
            "en":"<p>Make announcements or share a promotion.</p>",
            "es":"<p>Haz anuncios o comparte una promoción.</p>",
            "it":"<p>Fai annunci o condividi una promozione.</p>",
            "de":"<p>Machen Sie Ankündigungen oder teilen Sie eine Werbeaktion.</p>",
            "fr":"<p>Faites des annonces ou partagez une promotion.</p>"
          }
        },
        {
          "type":"header",
          "content":"t:general.headers.color.content"
        },
        {
          "type":"select",
          "id":"color_scheme",
          "label":"t:general.settings.color_scheme.label",
          "options":[
            {
              "value":"color__bg-body color__text",
              "label":"t:general.settings.color_scheme.body.label"
            },
            {
              "value":"color__bg-neutral color__text",
              "label":"t:general.settings.color_scheme.neutral.label"
            },
            {
              "value":"color__bg-overlay-1 color__text",
              "label":"t:general.settings.color_scheme.accent_1.label"
            },
            {
              "value":"color__bg-overlay-2 color__text",
              "label":"t:general.settings.color_scheme.accent_2.label"
            },
            {
              "value":"color__bg-overlay-3 color__text",
              "label":"t:general.settings.color_scheme.accent_3.label"
            },
            {
              "value":"color__bg-shade-1 color__text",
              "label":"t:general.settings.color_scheme.shade_1.label"
            },
            {
              "value":"color__bg-shade-2 color__text",
              "label":"t:general.settings.color_scheme.shade_2.label"
            },
            {
              "value":"color__bg-shade-3 color__text",
              "label":"t:general.settings.color_scheme.shade_3.label"
            },
            {
              "value":"color__bg-primary color__primary",
              "label":"t:general.settings.color_scheme.primary.label"
            },
            {
              "value":"color__bg-secondary color__secondary",
              "label":"t:general.settings.color_scheme.secondary.label"
            },
            {
              "value":"color__bg-tertiary color__tertiary",
              "label":"t:general.settings.color_scheme.tertiary.label"
            }
          ],
          "default":"color__bg-secondary color__secondary"
        },
        {
          "type":"header",
          "content":"t:general.headers.layout.content"
        },
        {
          "type":"select",
          "id":"layout_x_alignment",
          "label":"t:general.settings.x_alignment.label",
          "options":[
            {
              "value":"left",
              "label":"t:general.settings.x_alignment.left.label"
            },
            {
              "value":"center",
              "label":"t:general.settings.x_alignment.center.label"
            },
            {
              "value":"right",
              "label":"t:general.settings.x_alignment.right.label"
            }
          ],
          "default":"left"
        }
      ]
    }
  ],
  "disabled_on": {
    "groups": ["custom.overlay"]
  }
}
{% endschema %}