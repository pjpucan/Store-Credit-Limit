<!-- snippets/product__add.liquid -->
{% comment %} 
  This snippet is responsible for the "Add to Cart" functionality in product sections. It includes a quantity selector, variant picker, subscription options, and additional content. 

  Accepts:
  - blocksettings: {object}: A liquid object of block settings. This object contains the settings for the block in which the product is being displayed.
  - is_product_template: {boolean}: A flag indicating whether the current context is a product template.
  - is_featured: {boolean}: A flag indicating whether the product is featured.
  - is_edit_section: {boolean}: A flag indicating whether the current section is an edit overlay.
  
  Usage:
    {% render 'product__add', 
      block: block,
      is_featured: true,
      is_product_template: is_product_template,
      is_edit_section: true
    %}

  Globals:
  - variant_selection {string}: This setting allows you to set the variants style to either dropdown or buttons.
  - type_seperator {string}: This setting allows you to choose the type of separator between text.

  Recommendations:
  - Consider including a nesting container within the snippet for better organization and readability.
{% endcomment %}

{% comment %} Set product based on section settings {% endcomment %}
{% if is_featured %}
  {% assign product = section.settings.product %}
{% endif %}

{% unless product == null %}
  
  {% liquid
    assign enable_gift_card_recipient = false
    if block.settings.enable_gift_card_recipient and product.gift_card?
      assign enable_gift_card_recipient = true
    endif
  %}

  {% if enable_gift_card_recipient %}
    {% render 'product__gift-form' %}
  {% endif %}

  {% comment %} Add {% endcomment %}
  <div 
    id="product-add"
    class="w-full px-4"
    x-intersect:enter="stickyadd = false;"
    x-intersect:leave="stickyadd = true;">
    <div class="flex flex-wrap items-end gap-4">

      {% comment %} Action buttons {% endcomment %}
      <div class="flex flex-grow w-full gap-2">

        {% if block.settings.enable_quantity %}
          <label 
            class="sr-only" 
            for="{{ product.id }}-quantity">
            {{ 'labels.quantity' | t }}
          </label>
          <div 
            class="
              relative flex overflow-hidden max-w-[128px]
              border__input--radius border__input--radius border__input color__border-input hover:border__input--hover focus-within:border__input--focus
            " 
            x-data="{ 
              button_loading: false
            }">
            <input 
              id="{{ product.id }}-quantity"
              class="!border-0 text-left !rounded-none" 
              type="number" 
              name="quantity" 
              value="1"
              placeholder="1" 
              min="1"
              x-model='quantity'
              @change.debounce="
                button_loading = true; 
                handleProductFormChange({{ is_product_template }});
                setTimeout(function(){ button_loading = false}, 300);"
            >
            <div 
              class="
                btn__spinner !color__bg-overlay-1
                !w-full !top-0 !bottom-0 !left-0 !right-0 !transform-none
              "
              :class="{ '!visible !z-10' : button_loading }">
              {% render 'component__icon', icon: 'spinner', size: '24', class: '' %}
            </div>
            <div class="absolute right-0 flex flex-col justify-center h-full gap-0 color__bg-input">
              <button 
                class="btn btn--smaller btn--plain shrink-0 !rounded-none color__outline-input outline--width" 
                title="{{ 'actions.increase_item_quantity' | t }}"
                type="button"
                :disabled="button_loading || quantity >= current_variant_inventory_quantity && current_variant_inventory_quantity != 'deny'"
                @click="
                  button_loading = true; 
                  quantity++; 
                  handleProductFormChange({{ is_product_template }}); 
                  setTimeout(function(){ button_loading = false}, 500);
                ">
                {% render 'component__icon', icon: 'chevron-up', size: '14', class: '' %}
              </button>
              <button 
                class="btn btn--smaller btn--plain shrink-0 !rounded-none color__outline-input outline--width
                title="{{ 'actions.decrease_item_quantity' | t }}"
                type="button"
                :disabled="button_loading || quantity <= 1"
                @click="
                  button_loading = true; 
                  quantity--;
                  handleProductFormChange({{ is_product_template }}); 
                  setTimeout(function(){ button_loading = false}, 500);
                ">
                {% render 'component__icon', icon: 'chevron-down', size: '14', class: '' %}
              </button>
            </div>
          </div>
        {% endif %}
        
        {% comment %} Choose options, if non selected {% endcomment %}
        <button 
          class="btn !w-full btn--load btn--plain"  
          :class="{ 'btn--loading' : cart_loading && button_loading }"
          type="button" 
          role="button" 
          disabled
          :disabled="button_loading"
          @click="failed_clicked = true;"
          x-show="!all_options_selected"
          x-cloak>
          <div class="btn__content">
            {{ 'actions.choose_options' | t }}
          </div>
        </button>

        {% comment %} Sold out, if selected option unavailable {% endcomment %}
        <button class="btn !w-full btn--load btn--plain" 
          :class="{ 'btn--loading' : cart_loading && button_loading }" 
          type="button" 
          role="button"
          disabled  
          :disabled="button_loading"
          x-show="!current_variant_available && current_variant_exists && all_options_selected"  
          x-cloak>
          <div class="btn__content">
            {{ 'labels.sold_out' | t }}
          </div>
        </button>

        {% comment %} Unavailable, if selected option unavailable {% endcomment %}
        <button class="btn !w-full btn--load btn--plain" 
          :class="{ 'btn--loading' : cart_loading && button_loading }" 
          type="button" 
          role="button"
          disabled
          :disabled="button_loading"
          x-show="!current_variant_exists && all_options_selected"    
          x-cloak>
          <div class="btn__content">
            {{ 'labels.unavailable' | t }}
          </div>
        </button>

        {% comment %} Add to cart {% endcomment %}
        {% comment %} - Button will be hidden for when is_edit_section while variants aren't new {% endcomment %}
        <button class="btn !w-full btn--load {{ block.settings.color_button }}"  
          type="submit"
          role="button"
          :class="{ 'btn--loading' : cart_loading && button_loading }"
          :disabled="button_loading"
          {% if is_edit_section %}
            {% if product.selling_plan_groups.size > 0 %}
              x-show="current_variant_exists && current_variant_available && all_options_selected"
            {% else %}
              x-show="current_variant_exists && current_variant_available && all_options_selected && edit_variant != current_variant_id"
            {% endif %}
          {% else %}
            x-show="current_variant_exists && current_variant_available && all_options_selected"
          {% endif %}>
          <div class="btn__content">
            {% if product.metafields.custom.button_text %}
              {{ product.metafields.custom.button_text }} {% if settings.type_seperator == 'dot' %}·{% else %}|{% endif %}
            {% else %}
              {% if is_edit_section %}
                {{ 'actions.save_changes' | t }}
              {% else %}
                {{ 'actions.add_to_cart' | t }} 
              {% endif %}
              {% if settings.show_button_prices %}
                {% if settings.type_seperator == 'dot' %}·{% else %}|{% endif %}
              {% endif %}
            {% endif %}
            
            {% if settings.show_button_prices %}
              <span class="ml-1" 
                x-html="Shopify.formatMoney(calculated_price)">
                {% render 'component__format-price', price: product.price %}
              </span>
            {% endif %}
          </div>
          <div class="btn__spinner">
            {% render 'component__icon', icon: 'spinner', size: '24', class: '' %}
          </div>
        </button>
        
        {% comment %} Choose options when editing {% endcomment %}
        {% if is_edit_section and product.selling_plan_groups.size == 0 %}
          <button 
            class="btn !w-full btn--load btn--plain"  
            :class="{ 'btn--loading' : cart_loading && button_loading }"
            type="button" 
            role="button" 
            disabled
            :disabled="button_loading"
            x-show="edit_variant == current_variant_id">
            <div class="btn__content">
              {{ 'actions.choose_options' | t }}
            </div>
          </button>
        {% endif %}

      </div>

    </div>

    {% comment %} Set quantity to 1 when quantity input is disabled {% endcomment %}
    {% unless block.settings.enable_quantity %}
      <input 
        class="hidden" 
        type="number" 
        name="quantity" 
        placeholder="1" 
        min="1"
        value="1"
        x-model='quantity'
        hidden>
    {% endunless %}

  </div>

{% endunless %}